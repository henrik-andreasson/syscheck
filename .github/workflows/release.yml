name: release
on:
  push:
    tags:
      - "v*" # Trigger release creation on pushes to tags like v1.0.0, v1.0.1, etc.
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.2.3). Will create tag v1.2.3."
        required: true
        default: "2.9"
      tag_prefix: # Optional: Allows customization of the tag prefix
        description: "Prefix for the Git tag (e.g., v)"
        required: true
        default: "v"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # This token is needed for 'git push origin <tag>' if we create a tag manually
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v2
        with:
          python-version: 3.x
      - run: pip install mkdocs-material
      - run: mkdocs gh-deploy --force
      - run: sudo apt-get install ruby ruby-dev rubygems build-essential
      - run: sudo gem install --no-document fpm
      - run: sudo mkdir -p ../results

      - name: Run release script
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo ./lib/release.sh  -v ${{ github.event.inputs.version }} -p syscheck
          ls -lart ../releases
           TAG_NAME="v${{ github.event.inputs.version }}"
          DEB_PATH="../releases/syscheck*.deb"
          RELEASE_NAME="Release $TAG_NAME"
          RELEASE_BODY="## Release Notes for $TAG_NAME

          This release includes the latest deb package."

          echo "Creating GitHub Release for $TAG_NAME"

          # Try to create the release. If it already exists, upload the asset to the existing one.
          if gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "$RELEASE_BODY" \
            "$DEB_PATH"; then
            echo "Release created successfully."
          else
            echo "Failed to create release (it might already exist). Trying to upload asset to existing release..."
            # If the release exists, try to upload/update the asset to it
            if gh release upload "$TAG_NAME" "$DEB_PATH" --clobber; then
              echo "Asset uploaded/updated successfully to existing release."
            else
              echo "Failed to upload asset to existing release. Manual intervention might be needed."
              exit 1 # Fail the step if asset upload also fails
            fi
          fi
